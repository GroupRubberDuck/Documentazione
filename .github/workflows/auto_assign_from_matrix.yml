name: Auto-Assign from Matrix (Progetti V2)

# 1. TRIGGER: Ascolta i "project_v2_item" (Nuovi Progetti)
# Si attiva quando un campo (es. la colonna "Stato") viene modificato
on:
  project_card:
    types: [edited]

jobs:
  assign_from_matrix:
    runs-on: ubuntu-latest
    
    # 2. PERMESSI: Fondamentale. Senza questo, lo script fallisce.
    permissions:
      contents: read       # Per leggere il file matrix.json
      issues: write       # Per assegnare l'issue

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 3. FILTRO: Controlla se il campo modificato è quello delle colonne
      #    ATTENZIONE: Verifica che il tuo campo si chiami 'Stato'.
      #    Potrebbe essere 'Status' (in inglese) o altro.
      - name: Check if 'Stato' field was changed
        if: github.event.changes.field_value.field_name != 'Stato'
        run: |
          echo "Campo modificato: ${{ github.event.changes.field_value.field_name }}. Non è 'Stato'. Esco."
          exit 1 # Esce (non è un errore, salta solo l'esecuzione)

      # 4. RACCOLTA DATI
      - name: Get Issue Number and New Status
        id: get_info
        env:
          EVENT_PAYLOAD: ${{ toJSON(github.event) }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Estrae il NUOVO valore della colonna (es. "In review")
          # ATTENZIONE: Anche qui, cambia 'Stato' se il tuo campo ha un nome diverso
          COLUMN_NAME=$(echo "$EVENT_PAYLOAD" | jq -r '.project_v2_item.field_values[] | select(.field_name == "Stato") | .name')
          
          # Estrae l'URL e il numero dell'issue
          ISSUE_URL=$(echo "$EVENT_PAYLOAD" | jq -r '.project_v2_item.content_url')
          ISSUE_NUMBER=$(echo $ISSUE_URL | grep -o '[^/]*$')

          if [ -z "$ISSUE_NUMBER" ] || [ "$ISSUE_NUMBER" == "null" ]; then
            echo "La card non è un'issue. Esco."
            exit 0
          fi

          # Ottiene le etichette (labels) per quell'issue
          LABELS=$(curl -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github.v3+json" $ISSUE_URL | jq -r '.labels[].name')

          # Passa i dati allo step successivo
          echo "::set-output name=issue_number::$ISSUE_NUMBER"
          echo "::set-output name=column_name::$COLUMN_NAME"
          echo "::set-output name=labels::$LABELS"

      # 5. LOGICA DI ASSEGNAZIONE
      - name: Parse JSON Matrix and Assign
        env:
          ISSUE_NUMBER: ${{ steps.get_info.outputs.issue_number }}
          COLUMN_NAME: ${{ steps.get_info.outputs.column_name }}
          LABELS: ${{ steps.get_info.outputs.labels }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # --- Identifica il File ---
          # ATTENZIONE: Controlla che le tue etichette inizino con 'file_'
          FILE_KEY=""
          for LABEL in $LABELS; do
            if [[ $LABEL == file_* ]]; then
              FILE_KEY=$LABEL
              break
            fi
          done

          if [ -z "$FILE_KEY" ]; then
            echo "Nessuna etichetta 'file_...' trovata sull'issue. Esco."
            exit 0
          fi

          echo "Issue $ISSUE_NUMBER si riferisce a: $FILE_KEY"
          echo "Spostata nella colonna: $COLUMN_NAME"

          # --- Mappa Colonna a Ruolo ---
          # ATTENZIONE: Controlla che i nomi delle colonne siano ESATTI
          ROLE_KEY=""
          if [[ "$COLUMN_NAME" == "In review" ]]; then
            ROLE_KEY="revisore"
          elif [[ "$COLUMN_NAME" == "In validazione" ]]; then
            ROLE_KEY="validatore"
          elif [[ "$COLUMN_NAME" == "In progress" ]]; then
            ROLE_KEY="autore"
          else
            echo "Colonna $COLUMN_NAME non mappata. Esco."
            exit 0
          fi
          
          echo "Ruolo richiesto: $ROLE_KEY"

          # --- Trova Utente e Assegna ---
          # ATTENZIONE: Controlla che il percorso '.github/matrix.json' sia giusto
          ASSIGNEE=$(jq -r --arg filekey "$FILE_KEY" --arg rolekey "$ROLE_KEY" '.[$filekey][$rolekey]' .github/matrix.json)
          
          if [ -z "$ASSIGNEE" ] || [ "$ASSIGNEE" == "null" ]; then
            echo "ERRORE: Impossibile trovare l'utente per $FILE_KEY -> $ROLE_KEY nel JSON."
            exit 1
          fi

          echo "Utente da assegnare: $ASSIGNEE"

          # Esegui l'assegnazione (sostituendo i precedenti)
          curl -s -X POST -H "Authorization: Bearer $GH_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               -d "{\"assignees\":[\"$ASSIGNEE\"]}" \
               "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/assignees"
          
          echo "Assegnazione completata."
