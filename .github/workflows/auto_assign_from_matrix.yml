name: Auto-Assign from Matrix

# 1. TRIGGER: Si attiva quando un'issue in un progetto cambia
on:
  project_card:
    types: [moved]

jobs:
  assign_from_matrix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        # Fa il checkout del codice per poter leggere il file JSON
        uses: actions/checkout@v4

      - name: Parse JSON Matrix and Assign
        # Questo script usa l'utility 'jq' per manipolare il JSON
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Token per autenticarsi
          CARD_ID: ${{ github.event.project_card.id }}
          COLUMN_NAME: ${{ github.event.project_card.column_name }}
          ISSUE_URL: ${{ github.event.project_card.content_url }}
        run: |
          # --- Setup ---
          # Prende il numero dell'issue dall'URL (es. .../issues/123)
          ISSUE_NUMBER=$(echo $ISSUE_URL | grep -o '[^/]*$')
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "La card non Ã¨ un'issue. Esco."
            exit 0
          fi
          
          # --- 2. Identifica il File ---
          # Chiede a GitHub le etichette (labels) di quella issue
          LABELS=$(curl -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github.v3+json" $ISSUE_URL | jq -r '.labels[].name')
          
          # Trova la prima etichetta che inizia con "file_"
          FILE_KEY=""
          for LABEL in $LABELS; do
            if [[ $LABEL == file_* ]]; then
              FILE_KEY=$LABEL
              break
            fi
          done

          if [ -z "$FILE_KEY" ]; then
            echo "Nessuna etichetta 'file_...' trovata sull'issue. Esco."
            exit 0
          fi

          echo "Issue $ISSUE_NUMBER si riferisce a: $FILE_KEY"
          echo "Spostata nella colonna: $COLUMN_NAME"

          # --- 3 & 4. Leggi il JSON e Trova il Ruolo ---
          # Mappiamo i nomi delle colonne ai ruoli del JSON
          # NOTA: Adatta questa mappatura ai tuoi nomi esatti!
          ROLE_KEY=""
          if [[ "$COLUMN_NAME" == "In review" ]]; then
            ROLE_KEY="revisore"
          elif [[ "$COLUMN_NAME" == "In validazione" ]]; then
            ROLE_KEY="validatore"
          elif [[ "$COLUMN_NAME" == "In progress" ]]; then
            ROLE_KEY="autore"
          else
            echo "Colonna $COLUMN_NAME non mappata. Esco."
            exit 0
          fi
          
          echo "Ruolo richiesto: $ROLE_KEY"

          # --- 5 & 6. Trova l'Utente ---
          # Carica il JSON e pesca l'utente usando 'jq'
          ASSIGNEE=$(jq -r --arg filekey "$FILE_KEY" --arg rolekey "$ROLE_KEY" '.[$filekey][$rolekey]' .github/matrix.json)
          
          if [ -z "$ASSIGNEE" ] || [ "$ASSIGNEE" == "null" ]; then
            echo "ERRORE: Impossibile trovare l'utente per $FILE_KEY -> $ROLE_KEY"
            exit 1
          fi

          echo "Utente da assegnare: $ASSIGNEE"

          # --- 7. Assegna l'Utente ---
          # Usa l'API di GitHub per SOSTITUIRE gli assegnatari
          curl -s -X POST -H "Authorization: Bearer $GH_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               -d "{\"assignees\":[\"$ASSIGNEE\"]}" \
               "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/assignees"
          
          echo "Assegnazione completata."
