name: Auto-Assign from Matrix (Progetti V2)

on:
  project_v2_item:
    types: [edited] # Si attiva quando un campo (es. Status) viene modificato

jobs:
  assign_from_matrix:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 3. FILTRO RIMOSSO PER TEST
      # Il filtro 'if' è stato rimosso per vedere l'evento.

      # 4. RACCOLTA DATI
      - name: Get Issue Number and New Status
        id: get_info
        env:
          EVENT_PAYLOAD: ${{ toJSON(github.event) }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # STAMPIAMO L'EVENTO PER IL DEBUG
          echo "--- INIZIO EVENTO COMPLETO ---"
          echo "$EVENT_PAYLOAD" | jq .
          echo "--- FINE EVENTO COMPLETO ---"
          
          # Estrae il NUOVO valore della colonna (es. "In review")
          # IPOTIZZIAMO ANCORA CHE SI CHIAMI 'Status'
          COLUMN_NAME=$(echo "$EVENT_PAYLOAD" | jq -r '.project_v2_item.field_values[] | select(.field_name == "Status") | .name')
          
          # Estrae l'URL e il numero dell'issue
          ISSUE_URL=$(echo "$EVENT_PAYLOAD" | jq -r '.project_v2_item.content_url')
          ISSUE_NUMBER=$(echo $ISSUE_URL | grep -o '[^/]*$')

          if [ -z "$ISSUE_NUMBER" ] || [ "$ISSUE_NUMBER" == "null" ]; then
            echo "La card non è un'issue. Esco."
            exit 0
          fi

          # Ottiene le etichette (labels) per quell'issue
          LABELS=$(curl -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github.v3+json" $ISSUE_URL | jq -r '.labels[].name')

          # Passa i dati allo step successivo
          echo "::set-output name=issue_number::$ISSUE_NUMBER"
          echo "::set-output name=column_name::$COLUMN_NAME"
          echo "::set-output name=labels::$LABELS"

      # 5. LOGICA DI ASSEGNAZIONE
      - name: Parse JSON Matrix and Assign
        env:
          ISSUE_NUMBER: ${{ steps.get_info.outputs.issue_number }}
          COLUMN_NAME: ${{ steps.get_info.outputs.column_name }}
          LABELS: ${{ steps.get_info.outputs.labels }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # --- Identifica il File ---
          FILE_KEY=""
          for LABEL in $LABELS; do
            if [[ $LABEL == file_* ]]; then
              FILE_KEY=$LABEL
              break
            fi
          done

          if [ -z "$FILE_KEY" ]; then
            echo "Nessuna etichetta 'file_...' trovata sull'issue. Esco."
            exit 0
          fi

          echo "Issue $ISSUE_NUMBER si riferisce a: $FILE_KEY"
          echo "Spostata nella colonna: $COLUMN_NAME"

          # --- Mappa Colonna a Ruolo ---
          ROLE_KEY=""
          if [[ "$COLUMN_NAME" == "In review" ]]; then
            ROLE_KEY="revisore"
          elif [[ "$COLUMN_NAME" == "In validazione" ]]; then
            ROLE_KEY="validatore"
          elif [[ "$COLUMN_NAME" == "In progress" ]]; then
            ROLE_KEY="autore"
          else
            echo "Colonna $COLUMN_NAME non mappata. Esco."
            exit 0
          fi
          
          echo "Ruolo richiesto: $ROLE_KEY"

          # --- Trova Utente e Assegna ---
          ASSIGNEE=$(jq -r --arg filekey "$FILE_KEY" --arg rolekey "$ROLE_KEY" '.[$filekey][$rolekey]' .github/matrix.json)
          
          if [ -z "$ASSIGNEE" ] || [ "$ASSIGNEE" == "null" ]; then
            echo "ERRORE: Impossibile trovare l'utente per $FILE_KEY -> $ROLE_KEY nel JSON."
            exit 1
          fi

          echo "Utente da assegnare: $ASSIGNEE"

          # Esegui l'assegnazione
          curl -s -X POST -H "Authorization: Bearer $GH_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               -d "{\"assignees\":[\"$ASSIGNEE\"]}" \
               "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/assignees"
          
          echo "Assegnazione completata."